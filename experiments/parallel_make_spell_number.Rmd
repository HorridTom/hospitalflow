---
title: "Parallelisation of `make_spell_number` function"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Establishing a benchmark

```{r}
n_iters <- 1
old_times <- numeric()
for (i in 1:n_iters) {
  t0 = Sys.time()
  old <- hospitalflow::make_spell_number(
    ed_data = hospitalflow::ed_data,
    inpatient_data = hospitalflow::inpatient_data,
    )
  t1 = Sys.time()
  old_times <- c(old_times, t1-t0)
}
```

## With `data.table`

```{r}
n_iters <- 1
new_times <- numeric()
for (i in 1:n_iters) {
  t0 = Sys.time()
  new_dtbl <- hospitalflow::make_spell_number_dtbl(
    ed_data = hospitalflow::ed_data,
    inpatient_data = hospitalflow::inpatient_data,
    )
  t1 = Sys.time()
  new_times <- c(new_times, t1-t0)
}
```

## Compare the distributions after 100 experiments

```{r}
old_df <- cbind(old_times, rep(c("Benchmark"), 100))
dtbl_df <- cbind(new_times, rep(c("data.table"), 100)) 
df <- rbind(old_df, dtbl_df)
colnames(df) <- c("runtime", "type")
df <- as.data.frame(df)
df$runtime <- as.numeric(df$runtime)

ggplot2::ggplot(df,ggplot2::aes(x=runtime, fill=type)) + ggplot2::geom_density(alpha=0.25) +
  ggplot2::ggtitle("Distribution of make_spell_number runtime (100 iterations)") +
  ggplot2::xlab("Runtime, seconds") +
  ggplot2::xlim(c(0, 43))

```

## Are the outputs identical?

```{r}
base::identical(old, new_dtbl)
```

# Optimizing `spell_variables`

## Testing on `make_spell_table`

```{r eval=FALSE, include=FALSE}
t0 = Sys.time()
hospitalflow::make_spell_table(
  ed_data = hospitalflow::ed_data,
  inpatient_data = hospitalflow::inpatient_data,
)
t1 = Sys.time()
print(t1-t0)
```

2-3 seconds are for `make_spell_numbers_dtbl`, the rest is taken up by `spell_variables`.

```{r eval=FALSE, include=FALSE}
t0 = Sys.time()
spell_vars_const <- hospitalflow::spell_variables(
  all_episodes = new_dtbl
)
t1 = Sys.time()
print(t1-t0)
```

```{r eval=FALSE, include=FALSE}
t0 = Sys.time()
new_spell_vars_const <- hospitalflow::spell_variables_new(
  all_episodes = new_dtbl
)
t1 = Sys.time()
print(t1-t0)
```





```{r eval=FALSE, include=FALSE}
t0 = Sys.time()
spell_vars_gender <- hospitalflow::spell_variables(
  all_episodes = new_dtbl
)
t1 = Sys.time()
print(t1-t0)
```

```{r eval=FALSE, include=FALSE}
t0 = Sys.time()
new_spell_vars_gender <- hospitalflow::spell_variables_new(
  all_episodes = new_dtbl
)$gender_df
t1 = Sys.time()
print(t1-t0)
```



```{r eval=FALSE, include=FALSE}
t0 = Sys.time()
new_spell_vars_age_band <- hospitalflow::spell_variables_new(
  all_episodes = new_dtbl
)$age_band_df
t1 = Sys.time()
print(t1-t0)
```



```{r eval=FALSE, include=FALSE}
t0 = Sys.time()
new_spell_vars_ep_class_seq <- hospitalflow::spell_variables_new(
  all_episodes = new_dtbl
)$ep_class_seq_df
t1 = Sys.time()
print(t1-t0)
```



```{r eval=FALSE, include=FALSE}
t0 = Sys.time()
new_spell_vars_admission_type <- hospitalflow::spell_variables_new(
  all_episodes = new_dtbl
)$admission_type_df
t1 = Sys.time()
print(t1-t0)
```
```{r eval=FALSE, include=FALSE}
t0 = Sys.time()
new_spell_vars_datetime <- hospitalflow::spell_variables_new(
  all_episodes = new_dtbl
)$datetime_df
t1 = Sys.time()
print(t1-t0)
```





# Getting the output of spell_variables
```{r eval=FALSE, include=FALSE}
t0 = Sys.time()
spell_variables_ep_lists <- hospitalflow::spell_variables(
  all_episodes = new_dtbl
)
t1 = Sys.time()
print(t1-t0)

saveRDS(spell_variables_ep_lists, "spell_variables_ep_lists.rds")
```


# Getting the output of spell_variables_new
```{r eval=FALSE, include=FALSE}
t0 = Sys.time()
new_spell_vars_final <- hospitalflow::spell_variables_new(
  all_episodes = new_dtbl
)
t1 = Sys.time()
print(t1-t0)
```

# Testing `make_spell_table` after optimization
```{r eval=FALSE, include=FALSE}
n_iters <- 50
new_times <- numeric()
for (i in 1:n_iters) {
  t0 = Sys.time()
  spell_tbl <- hospitalflow::make_spell_table(hospitalflow::ed_data, hospitalflow::inpatient_data)
  t1 = Sys.time()
  new_times <- c(new_times, t1-t0)
}
```


