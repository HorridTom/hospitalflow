---
title: "`r params$title`"
author: "`r params$author`"
date: "`r Sys.Date()`"
output: html_document
params:
  title: "Example Hospital Flow Report"
  author: "CLAHRC NWL Information Intelligence Team"
  hospital_name: "Anytown General Hospital"
  import_list_path: "../example-config/example_import_list.rds"
  sample_weeks: 20
  sample_no_of_patients: NULL
  use_existing_spell_table: TRUE
  existing_spell_table_path: "../data/spell_table.rda"
  existing_moves_table_path: "../data/moves_table.rda"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)

library(magrittr)

sample_duration <- lubridate::duration(params$sample_weeks, "weeks")
sample_no_of_patients <- params$sample_no_of_patients
```

Package version: `r stringr::str_sub(system("git rev-parse HEAD", intern=TRUE), 1, 8)`

Number of weeks used as sample: `r params$sample_weeks`

Number of patients sampled: `r params$sample_no_of_patients`

```{r import-data, cache=TRUE, echo=FALSE}
if(params$use_existing_spell_table == FALSE){
  # Import and Standardise Data

import_list <- readRDS(params$import_list_path)

# This import list uses relative paths (good for us during development)
# which means the paths need prepending with "../" to work from the
# working directory used in running this file.
# In production use, users will be best specifying their import paths
# as absolute paths.
import_list <- lapply(import_list, function(x) {
  list(data_path = paste0("../", x$data_path),
  config_path = paste0("../", x$config_path),
  site = x$site,
  facility = x$facility,
  time_zone = x$time_zone)
})

data_list <- hospitalflow::import_standardise_bind(import_list)
}
```

```{r spell-table, cache=TRUE, echo=FALSE}
if(params$use_existing_spell_table == FALSE){
  ed_data <- data_list[["ED"]] 
  inpatient_data <- data_list[["IP"]] 
  
  data_start_date <- as.Date(max(min(ed_data$start_datetime, na.rm = TRUE),
                         min(ed_data$end_datetime, na.rm = TRUE),
                         min(inpatient_data$start_datetime, na.rm = TRUE),
                         min(inpatient_data$end_datetime, na.rm = TRUE)))
  data_end_date <- as.Date(min(max(ed_data$start_datetime, na.rm = TRUE),
                       max(ed_data$end_datetime, na.rm = TRUE),
                       max(inpatient_data$start_datetime, na.rm = TRUE),
                       max(inpatient_data$end_datetime, na.rm = TRUE)))
  start_date <- data_start_date
  end_date <- data_end_date

  #samples down by time frame
  if(!is.null(params$sample_weeks)) {
    
    data_start_date <- lubridate::ceiling_date(data_start_date, "month")
    data_end_date <- lubridate::floor_date(data_end_date, "month")
    
    if(data_end_date - data_start_date > sample_duration) {
      start_date <- data_end_date - sample_duration
      end_date <- data_end_date
      example_ed_data <- ed_data %>% dplyr::filter(start_datetime <= end_date,
                                                   end_datetime >= start_date)
      example_inpatient_data <- inpatient_data %>% dplyr::filter(start_datetime <= end_date,
                                                                 end_datetime >= start_date)
    } else {
      example_ed_data <- ed_data
      example_inpatient_data <- inpatient_data
    }
  } else {
    example_ed_data <- ed_data
    example_inpatient_data <- inpatient_data
  }

  #samples down by number of patients 
  if(!is.null(sample_no_of_patients)) {
    
    inpatients <- levels(factor(example_inpatient_data$pseudo_id))
    sample_inpatients <- sample(inpatients, sample_no_of_patients)
    
    example_ed_data <- example_ed_data %>% 
      dplyr::filter(pseudo_id %in% sample_inpatients)
    
    example_inpatient_data <- example_inpatient_data %>%
      dplyr::filter(pseudo_id %in% sample_inpatients)
  
  } 

  example_spell_list <- hospitalflow::make_spell_table(ed_data = example_ed_data,
                                                        inpatient_data = example_inpatient_data)
  example_spell_table <- example_spell_list$spell_table
  example_all_episodes <- example_spell_list$all_episodes
  
  example_spell_table <- hospitalflow::add_spell_variables(ed_data = example_ed_data,
                                                           inpatient_data = example_inpatient_data,
                                                           spell_table = example_spell_table)
  example_moves_table <- hospitalflow::make_moves_table(ed_data = example_ed_data,
                                                        inpatient_data = example_inpatient_data,
                                                        all_episodes = example_all_episodes,
                                                        ward_mapping_config_path = import_list$ip_import$config_path)
}else{
  #pointing to existing spell table 
  
  load(params$existing_spell_table_path)
  load(params$existing_moves_table_path)
  
  example_spell_table <- spell_table
  example_moves_table <- moves_table
  
  data_start_date <- as.Date(max(
    min(example_spell_table$spell_start, na.rm = TRUE),
    min(example_spell_table$spell_end, na.rm = TRUE),
    min(example_moves_table$move_datetime, na.rm = TRUE)
    ))
  
  data_end_date <- as.Date(min(
    max(example_spell_table$spell_start, na.rm = TRUE),
    max(example_spell_table$spell_end, na.rm = TRUE),
    max(example_moves_table$move_datetime, na.rm = TRUE)
    ))
  
  start_date <- data_start_date
  end_date <- data_end_date
  
  #samples down by time frame
  if(!is.null(params$sample_weeks)) {
    
    data_start_date <- lubridate::ceiling_date(data_start_date, "month")
    data_end_date <- lubridate::floor_date(data_end_date, "month")
    
    if(data_end_date - data_start_date > sample_duration) {
      start_date <- data_end_date - sample_duration
      end_date <- data_end_date
      example_spell_table <- example_spell_table %>% 
        dplyr::filter(spell_start <= end_date,
                      spell_end >= start_date)
      example_moves_table <- example_moves_table %>% 
        dplyr::filter(move_datetime <= end_date,
                      move_datetime >= start_date)
    }
  }

  #samples down by number of patients 
  if(!is.null(sample_no_of_patients)) {
    
    patients <- levels(factor(example_spell_table$pseudo_id))
    sample_patients <- sample(patients, sample_no_of_patients)
    
    example_spell_table <- example_spell_table %>% 
      dplyr::filter(pseudo_id %in% sample_patients)
    
    example_moves_table <- example_moves_table %>%
      dplyr::filter(pseudo_id %in% sample_patients)
  
  } 

}


```


## Age and Gender

```{r age-gender-ed, echo=F, results='asis', fig.height=5, fig.width=7, cache=TRUE}
hospitalflow::ae_attendances_admissions_age_sex(start_date = start_date, end_date = end_date,
                                                data = example_spell_table,
                                                plot_chart = TRUE,
                                                hospital_name = "Anytown General Hospital")
```

## Arrival Occupancy

```{r arr-occ, echo=F, results='asis', fig.height=5, fig.width=7, cache=TRUE}
hospitalflow::ae_arrival_occupancy(start_date = as.POSIXct(start_date, tz = "Europe/London"),
                                   end_date = as.POSIXct(end_date, tz = "Europe/London"),
                                   data = example_spell_table,
                                   plot_chart = TRUE,
                                   hospital_name = "Anytown General Hospital")
```

## Four hour performance by flow group

```{r four-hour-flow-group, echo=F, results='asis', fig.height=5, fig.width=7, cache=TRUE}
hospitalflow::four_hrs_perf_flow_groups(start_dt = as.Date(start_date),
                                   end_dt = as.Date(end_date),
                                   data = example_spell_table,
                                   time_unit = "day",
                                   plot_chart = TRUE,
                                   hospital_name = "Anytown General Hospital")
```

## Duration in ED by flow group

```{r crisis-spike, echo=F, results='asis', fig.height=5, fig.width=7, cache=TRUE }
hospitalflow::ed_los_flow_grps(start_date = start_date, end_date = end_date,
                             data = example_spell_table,
                             plot_chart = TRUE,
                             hospital_name = "Anytown General Hospital")
```



## Duration in ED by admitted/non-admitted

```{r los-ed, echo=F, results='asis', fig.height=5, fig.width=7, cache=TRUE}
hospitalflow::los_att_adm_ae(start_date = start_date, end_date = end_date,
                             data = example_spell_table,
                             plot_chart = TRUE,
                             hospital_name = "Anytown General Hospital")
```

## Duration in ED by flow group

```{r los-ed-flow,  echo=F, results='asis', fig.height=5, fig.width=7, cache=TRUE}
hospitalflow::average_ed_los_flows(start_date = start_date, end_date = end_date,
                             data = example_spell_table,
                             plot_chart = TRUE,
                             hospital_name = "Anytown General Hospital")
```



## Admissions and Discharges by Day of Week


```{r adm-disch-dow, echo=F, results='asis', fig.height=5, fig.width=7, cache=TRUE}
hospitalflow::admissions_discharges(start_date = start_date, end_date = end_date,
                                    data = example_spell_table,
                                    plot_chart = TRUE,
                                    hospital_name = "Anytown General Hospital")
```


## Length of Stay

```{r los-dist, echo=F, results='asis', fig.height=5, fig.width=7, cache=TRUE}
hospitalflow::los_distrib_method_admission(start_date = start_date, end_date = end_date,
                                           data = example_spell_table,
                                           plot_chart = TRUE,
                                           hospital_name = "Anytown General Hospital")
```

## ED occupancy by hour of week
```{r ed-occ-1, echo=F, results='asis', fig.height=5, fig.width=7, fig.align = 'left', cache=TRUE}
hospitalflow::occupancy_weekday_hour(start_date = as.POSIXct(start_date, tz = "Europe/London"),
                                   end_date = as.POSIXct(end_date, tz = "Europe/London"),
                                   data = example_spell_table,
                                   plot_chart = TRUE,
                                   hospital_name = "Anytown General Hospital")
```

## Monthly 7-day Readmission Rate
```{r readm-7, echo=F, results='asis', fig.height=5, fig.width=7, fig.align = 'left', cache=TRUE}
hospitalflow::readmissions_ip(start_date = as.POSIXct(start_date, tz = "Europe/London"),
                              end_date = as.POSIXct(end_date, tz = "Europe/London"),
                              data = example_spell_table,
                              plot_chart = TRUE,
                              hospital_name = "Anytown General Hospital",
                              readmission_by = 7)
```

## Monthly 30-day Readmission Rate
```{r readm-30, echo=F, results='asis', fig.height=5, fig.width=7, fig.align = 'left', cache=TRUE}
hospitalflow::readmissions_ip(start_date = as.POSIXct(start_date, tz = "Europe/London"),
                              end_date = as.POSIXct(end_date, tz = "Europe/London"),
                              data = example_spell_table,
                              plot_chart = TRUE,
                              hospital_name = "Anytown General Hospital",
                              readmission_by = 30)
```

## Monthly 90-day Readmission Rate
```{r readm-90, echo=F, results='asis', fig.height=5, fig.width=7, fig.align = 'left', cache=TRUE}
hospitalflow::readmissions_ip(start_date = as.POSIXct(start_date, tz = "Europe/London"),
                              end_date = as.POSIXct(end_date, tz = "Europe/London"),
                              data = example_spell_table,
                              plot_chart = TRUE,
                              hospital_name = "Anytown General Hospital",
                              readmission_by = 90)
```

## Sankey Flow Diagram High Level
```{r sankey-high-level, echo=F, results='asis', fig.height=5, fig.width=7, fig.align = 'left', cache=TRUE}
hospitalflow::plot_flow_diagram(moves_table = example_moves_table,
                                ward_level = F,
                                start = NULL,
                                end = NULL,
                                selected_levels = NULL,
                                remove_static_moves = F)
```

## Sankey Flow Diagram Ward Level
```{r sankey-ward-level, echo=F, results='asis', fig.height=5, fig.width=7, fig.align = 'left', cache=TRUE}
hospitalflow::plot_flow_diagram(moves_table = example_moves_table,
                                ward_level = T,
                                start = NULL,
                                end = NULL,
                                selected_levels = NULL,
                                remove_static_moves = F)
```
